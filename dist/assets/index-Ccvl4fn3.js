(function(){const o=document.createElement("link").relList;if(o&&o.supports&&o.supports("modulepreload"))return;for(const c of document.querySelectorAll('link[rel="modulepreload"]'))m(c);new MutationObserver(c=>{for(const e of c)if(e.type==="childList")for(const r of e.addedNodes)r.tagName==="LINK"&&r.rel==="modulepreload"&&m(r)}).observe(document,{childList:!0,subtree:!0});function u(c){const e={};return c.integrity&&(e.integrity=c.integrity),c.referrerPolicy&&(e.referrerPolicy=c.referrerPolicy),c.crossOrigin==="use-credentials"?e.credentials="include":c.crossOrigin==="anonymous"?e.credentials="omit":e.credentials="same-origin",e}function m(c){if(c.ep)return;c.ep=!0;const e=u(c);fetch(c.href,e)}})();(function(){function i(e,r){const w=document.getElementById("logList");if(!w)return;const f=document.createElement("div");f.className="it",f.textContent=`[${new Date().toLocaleTimeString()}] ${String(e).toUpperCase()}: ${r}`,w.prepend(f)}function o(e,r){const w=document.getElementById("status");w&&(w.textContent=e,w.className=r||"")}function u(){return new URL(location.href).searchParams.get("room")}function m(){const e=navigator.userAgent||"",r=/WhatsApp/i.test(e)||/wv\)/i.test(e)&&/WhatsApp/i.test(navigator.appVersion||""),w=/FBAN|FBAV|FB_IAB|FBAN\//i.test(e),f=/Instagram/i.test(e),g=/Telegram/i.test(e);return{inApp:r||w||f||g}}function c(){const e=window.isSecureContext,r=!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),w=typeof RTCPeerConnection=="function",f=m(),g=document.getElementById("dbgProto"),y=document.getElementById("dbgSecure"),l=document.getElementById("dbgGUM"),h=document.getElementById("dbgPC"),s=document.getElementById("dbgUA"),S=document.getElementById("dbgInApp");g&&(g.textContent=location.protocol),y&&(y.textContent=String(e)),l&&(l.textContent=String(r)),h&&(h.textContent=String(w)),s&&(s.textContent=navigator.userAgent),S&&(S.textContent=f.inApp?"in-app":"нет")}try{typeof window<"u"&&(window.addLog||(window.addLog=i),window.setStatus||(window.setStatus=o),window.parseRoom||(window.parseRoom=u),window.detectInApp||(window.detectInApp=m),window.renderEnv||(window.renderEnv=c))}catch{}})();(function(){const i=window.__APP_CONFIG__||{SERVER_URL:"https://call.zababba.com/signal",WS_URL:"wss://call.zababba.com/ws"};let o=null,u=null;function m(){return!!(o&&o.readyState===WebSocket.OPEN)}function c(g=3e3){return m()?Promise.resolve():new Promise((y,l)=>{const h=Date.now(),s=setInterval(()=>{if(m()){clearInterval(s),y();return}Date.now()-h>=g&&(clearInterval(s),l(new Error("WS не подключён")))},50)})}async function e(g){const y=`${i.SERVER_URL}/rooms`;try{const l=await fetch(y,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(g?{roomId:g}:{})});if(!l.ok){const h=await l.text().catch(()=>"");throw new Error(`create room failed: ${l.status} ${l.statusText}${h?" - "+h:""}`)}return l.json()}catch(l){throw window.addLog&&window.addLog("error",l.message||String(l)),l}}function r(g,y,l){return new Promise((h,s)=>{let S=0;const t=1e4;let d=!1,a=!1;const _=()=>{const A=new URLSearchParams({roomId:y,role:g}).toString(),v=`${i.WS_URL}?${A}`;window.addLog&&window.addLog("signal",`connect WS ${v}`),o=new WebSocket(v),o.onopen=()=>{window.addLog&&window.addLog("signal","ws open"),u=setInterval(()=>{try{o==null||o.send(JSON.stringify({type:"ping",t:Date.now()}))}catch{}},2e4),S=0},o.onmessage=L=>{let b;try{b=JSON.parse(L.data)}catch{b=L.data}if(typeof b=="object"&&b&&b.type==="ping"){window.addLog&&window.addLog("signal","recv ping");return}b&&b.type==="hello"&&!d&&(d=!0,h({memberId:b.memberId||"unknown"})),l&&l(b)},o.onerror=()=>{window.addLog&&window.addLog("error","ws error")},o.onclose=L=>{if(window.addLog&&window.addLog("signal",`ws close code=${L.code} reason=${L.reason||"-"}`),u&&(clearInterval(u),u=null),L.code===1e3||L.code===1005){a=!0;return}if(!d){s(new Error("WebSocket closed before hello"));return}if(!a){S+=1;const E=Math.min(500*2**(S-1),t);typeof window.setStatus=="function"&&window.setStatus("восстанавливаем сигналинг…","warn"),window.addLog&&window.addLog("signal",`ws reconnect in ${E}ms (attempt ${S})`),setTimeout(()=>{o&&o.readyState===WebSocket.OPEN||_()},E)}}};if(o&&o.readyState===WebSocket.OPEN){window.addLog&&window.addLog("warn",`WS уже подключён (${g})`),h({memberId:"already-open"});return}_()})}function w(g,y){try{o&&o.readyState===WebSocket.OPEN&&(o.send(JSON.stringify({type:g,...y?{payload:y}:{}})),window.addLog&&window.addLog("signal",`send ${g}`))}catch(l){window.addLog&&window.addLog("error",l.message||String(l))}}function f(){try{o&&o.close()}catch{}u&&(clearInterval(u),u=null),o=null}try{typeof window<"u"&&(window.apiCreateRoom||(window.apiCreateRoom=e),window.connectWS||(window.connectWS=r),window.wsSend||(window.wsSend=w),window.wsClose||(window.wsClose=f),window.isWSOpen||(window.isWSOpen=m),window.waitWSOpen||(window.waitWSOpen=c),window.__SIGNALING__={apiCreateRoom:e,connectWS:r,wsSend:w,wsClose:f,isWSOpen:m,waitWSOpen:c})}catch{}})();(function(){let i=null,o=null,u=null,m=!1,c=!1,e=[];function r(){return i}async function w(t){if(t)try{i&&c?await i.addIceCandidate(new RTCIceCandidate(t)):e.push(t)}catch{}}async function f(t){if(t)try{if(!i)return;for(await i.setRemoteDescription(new RTCSessionDescription(t)),c=!0;e.length;){const d=e.shift();try{await i.addIceCandidate(new RTCIceCandidate(d))}catch{}}}catch{}}async function g(){try{return o=await navigator.mediaDevices.getUserMedia({audio:!0}),window.addLog&&window.addLog("info","mic ok"),o}catch(t){throw window.addLog&&window.addLog("error","mic error: "+(t.message||t)),t}}function y(){const t={iceServers:[{urls:"stun:stun.l.google.com:19302"}]},d=typeof window<"u"?window.__TURN__:null;if(d&&Array.isArray(d.iceServers)&&d.iceServers.length){const a={iceServers:d.iceServers.slice()};return d.forceRelay&&(a.iceTransportPolicy="relay"),a}return t}function l(t){const d=y();try{window.addLog&&window.addLog("webrtc","create RTCPeerConnection "+(d.iceTransportPolicy?`(policy=${d.iceTransportPolicy})`:""))}catch{}if(i=new RTCPeerConnection(d),i.onicecandidate=a=>{a.candidate&&window.wsSend&&window.wsSend("ice",a.candidate)},i.onicegatheringstatechange=()=>{const a=i.iceGatheringState;window.addLog&&window.addLog("webrtc",`gathering=${a}`),a==="complete"&&window.addLog&&window.addLog("webrtc","ICE gathering complete")},i.oniceconnectionstatechange=()=>{const a=i.iceConnectionState;window.addLog&&window.addLog("webrtc",`ice=${a}`),typeof window.setStatus=="function"&&(a==="connected"?window.setStatus("соединение установлено","ok"):a==="checking"?window.setStatus("соединяемся…","warn"):a==="disconnected"?window.setStatus("соединение потеряно, пытаемся восстановить…","warn"):a==="failed"&&window.setStatus("ошибка соединения","err"))},i.onconnectionstatechange=()=>{const a=i.connectionState;window.addLog&&window.addLog("webrtc",`state=${a}`),typeof window.setStatus=="function"&&(a==="connected"?window.setStatus("соединение установлено","ok"):a==="connecting"?window.setStatus("соединяемся…","warn"):a==="disconnected"?window.setStatus("соединение потеряно, пытаемся восстановить…","warn"):a==="failed"?window.setStatus("ошибка соединения","err"):a==="closed"&&window.setStatus("соединение закрыто","warn"))},i.ontrack=a=>{t&&t(a.streams[0])},o)for(const a of o.getTracks())i.addTrack(a,o);return i}async function h(t=!1){try{if(!(window.isWSOpen&&window.isWSOpen())||!i||!o||m&&!t)return;const d=await i.createOffer();await i.setLocalDescription(d),window.wsSend&&window.wsSend("offer",d),m=!0,window.addLog&&window.addLog("signal","send offer")}catch(d){window.addLog&&window.addLog("error","sendOfferIfPossible: "+(d.message||d))}}async function s(t,d){try{if(!t){window.addLog&&window.addLog("warn","acceptIncoming: no offer");return}i||l(d),await i.setRemoteDescription(new RTCSessionDescription(t));const a=await i.createAnswer();for(await i.setLocalDescription(a),window.wsSend&&window.wsSend("answer",a),c=!0;e.length;){const _=e.shift();try{await i.addIceCandidate(new RTCIceCandidate(_))}catch{}}}catch(a){window.addLog&&window.addLog("error","acceptIncoming: "+(a.message||a))}}function S(t=""){try{i&&(i.close(),i=null),o=null,u=null,m=!1,c=!1,e=[],window.addLog&&window.addLog("info","cleanup "+t)}catch{}}try{typeof window<"u"&&(window.__WEBRTC__={getMic:g,createPC:l,sendOfferIfPossible:h,acceptIncoming:s,cleanup:S,getPC:r,addRemoteIce:w,applyAnswer:f},window.getPC||(window.getPC=r),window.addRemoteIce||(window.addRemoteIce=w),window.applyAnswer||(window.applyAnswer=f),window.getMic||(window.getMic=g),window.createPC||(window.createPC=l),window.sendOfferIfPossible||(window.sendOfferIfPossible=h),window.acceptIncoming||(window.acceptIncoming=s),window.cleanup||(window.cleanup=S))}catch{}})();(function(){const i=document.getElementById("btnHowTo"),o=document.getElementById("btnAbout"),u=document.getElementById("btnDebug"),m=document.getElementById("dlgHowTo"),c=document.getElementById("dlgAbout"),e=document.getElementById("debugBlock"),r=document.getElementById("note"),w=document.getElementById("shareWrap"),f=document.getElementById("shareLink"),g=document.getElementById("btnNativeShare"),y=document.getElementById("btnCopy"),l=document.getElementById("btnCopyDiag");i&&m&&(i.onclick=()=>m.showModal()),o&&c&&(o.onclick=()=>c.showModal()),u&&e&&(u.onclick=()=>e.classList.toggle("hidden")),g&&f&&(g.onclick=()=>{const s=f.value||"";navigator.share?navigator.share({title:"Приглашение на звонок",text:`Вам звонят: ${s}`,url:s}).catch(()=>{}):r&&(r.textContent="Native Share недоступен")}),y&&f&&(y.onclick=async()=>{try{await navigator.clipboard.writeText(f.value||""),r&&(r.textContent="Ссылка скопирована")}catch{r&&(r.textContent="Скопируйте вручную")}}),l&&(l.onclick=async()=>{const s=window.__APP_CONFIG__||{SERVER_URL:"",WS_URL:""},S=["=== DIAG REPORT ===","url: "+location.href,"secure: "+window.isSecureContext,"protocol: "+location.protocol,"ua: "+navigator.userAgent,"getUserMedia: "+!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),"RTCPeerConnection: "+typeof RTCPeerConnection,"server: "+s.SERVER_URL,"ws: "+s.WS_URL,"room: "+(window.parseRoom&&window.parseRoom()||"-")].join(`
`);try{await navigator.clipboard.writeText(S)}catch{alert(S)}});function h(s){const t=`${location.origin+location.pathname}?room=${encodeURIComponent(s)}`;f&&(f.value=t),w&&w.classList.remove("hidden")}window.shareRoomLink||(window.shareRoomLink=h),window.__UI__={shareRoomLink:h}})();(function(){if(window.__CALL_APP_LOADED__)return;window.__CALL_APP_LOADED__=!0;const o=document.getElementById("status"),u=document.getElementById("note"),m=document.getElementById("roomNote"),c=document.getElementById("remoteAudio"),e=document.getElementById("btnCall"),r=document.getElementById("btnAnswer"),w=document.getElementById("btnHang"),f=document.getElementById("shareWrap"),g=document.getElementById("shareLink"),y=document.getElementById("btnNativeShare"),l=document.getElementById("btnCopy"),h=document.getElementById("btnCopyDiag"),s=(n,p)=>{if(o){o.textContent=n;const C=o.closest(".pill")||o.parentElement;C&&C.classList&&(C.classList.remove("ok","warn","warn-txt","err"),p&&C.classList.add(p))}try{typeof window.setStatus=="function"&&window.setStatus(n,p)}catch{}},S=window.renderEnv||(()=>{}),t=window.addLog||(()=>{}),d=window.parseRoom||(()=>new URLSearchParams(location.search).get("room")),a=window.connectWS||(async()=>{}),_=window.wsSend||(()=>{}),A=window.wsClose||(()=>{}),v=window.isWSOpen||(()=>!1),L=window.waitWSOpen||(async()=>{}),b=window.apiCreateRoom||(async()=>{throw new Error("apiCreateRoom missing")}),E=window.getMic||(async()=>{}),T=window.createPC||(()=>{}),x=window.acceptIncoming||(async()=>{}),U=window.applyAnswer||(async()=>{}),N=window.addRemoteIce||(async()=>{}),D=window.cleanup||(()=>{}),k=window.__APP_CONFIG__&&window.__APP_CONFIG__.SERVER_URL||`${location.origin}/signal`,$=window.__APP_CONFIG__&&window.__APP_CONFIG__.WS_URL||`${location.origin.replace(/^http/,"ws")}/ws`;let I=null,W=null,P=null,G=null,R=null;async function O(n){try{if(!n||typeof n!="object")return;switch(n.type){case"hello":{W=n.memberId||W,s(`WS подключён. Комната ${I||d()||"-"}`,"ok"),m&&(m.textContent=`Комната: ${I||d()||"-"}`),t("signal","recv hello");break}case"member.joined":{t("signal","recv member.joined");try{P==="caller"&&(typeof window.sendOfferIfPossible=="function"?(await window.sendOfferIfPossible(!0),t("webrtc","offer sent (caller)")):typeof window.createAndSendOffer=="function"?(await window.createAndSendOffer(),t("webrtc","offer sent via createAndSendOffer")):t("warn","no offer sender impl (sendOfferIfPossible/createAndSendOffer)"))}catch(p){t("error","sendOfferIfPossible: "+((p==null?void 0:p.message)||p))}break}case"offer":{t("signal","recv offer"),R=n.payload||n.offer||null,R&&(r&&r.classList.remove("hidden"),s("получен оффер — нажмите «Ответить на звонок»","warn"));break}case"answer":{if(t("signal","recv answer"),n.payload)try{await U(n.payload)}catch(p){t("error","applyAnswer: "+(p.message||p))}break}case"ice":{const p=n.payload||n.candidate;if(p)try{await N(p)}catch(C){t("error","addRemoteIce: "+(C.message||C))}break}case"bye":{t("signal","recv bye"),B("peer-bye");break}default:break}}catch(p){t("error","onSignal: "+(p.message||p))}}function M(n){const C=`${location.origin+location.pathname}?room=${encodeURIComponent(n)}`;g&&(g.value=C),f&&f.classList.remove("hidden")}async function F(){L&&await L(3e3),s("подготовка…","warn-txt"),e&&(e.disabled=!0),await E(),T(n=>{c&&(c.srcObject=n),t("webrtc","remote track")}),s("Комната готова. Поделитесь ссылкой или ждите входа собеседника","ok"),w&&(w.disabled=!1)}function B(n="user-hangup"){try{_("bye",{reason:n})}catch{}try{A()}catch{}try{D(n)}catch{}clearInterval(G);const p=!!d();w&&(w.disabled=!0),e&&e.classList.toggle("hidden",p),r&&r.classList.toggle("hidden",!p),f&&f.classList.add("hidden"),s("звонок завершён","warn-txt"),u&&(u.textContent="")}async function j(){const n=d();if(!n){t("info","нет room в URL — это Caller"),s("Готов","ok"),m&&(m.textContent="Режим: инициатор");return}m&&(m.textContent=`Комната: ${n}`),P="callee",I=n,await a("callee",n,O),s("WS подключён, ждём оффер","ok"),r&&r.classList.remove("hidden"),e&&e.classList.add("hidden")}e&&(e.onclick=async()=>{try{e.disabled=!0,s("Создаём комнату…","warn");const n=await b(k);I=n&&n.roomId||null,P="caller",await a("caller",I,O),M(I),await F(),s("Комната готова. Поделитесь ссылкой или ждите входа собеседника","ok"),w&&(w.disabled=!1)}catch(n){s("ошибка создания комнаты","err"),t("error",n&&n.message?n.message:String(n)),u&&(u.textContent=n&&n.message?n.message:String(n)),e.disabled=!1}}),r&&(r.onclick=async()=>{const n=d();if(!n){alert("Откройте приглашение с ?room=…"),t("warn","btnAnswer без room");return}P="callee",I=n,v()?t("warn","WS уже подключён (callee)"):await a("callee",n,O),R?(await x(R,p=>{c&&(c.srcObject=p),t("webrtc","remote track")}),R=null,w&&(w.disabled=!1)):(t("warn","btnAnswer без оффера"),s("ждём оффер…","warn"))}),w&&(w.onclick=()=>B("user-hangup")),y&&(y.onclick=()=>{const n=g&&g.value||"";navigator.share?navigator.share({title:"Приглашение на звонок",text:`Вам звонят: ${n}`,url:n}).catch(()=>{}):u&&(u.textContent="Native Share недоступен")}),l&&(l.onclick=async()=>{try{await navigator.clipboard.writeText(g&&g.value||""),u&&(u.textContent="Ссылка скопирована")}catch{u&&(u.textContent="Скопируйте вручную")}}),h&&(h.onclick=async()=>{const n=["=== DIAG REPORT ===","url: "+location.href,"secure: "+window.isSecureContext,"protocol: "+location.protocol,"ua: "+navigator.userAgent,"getUserMedia: "+!!(navigator.mediaDevices&&navigator.mediaDevices.getUserMedia),"RTCPeerConnection: "+typeof RTCPeerConnection,"server: "+k,"ws: "+$,"room: "+(I||d()||"-")].join(`
`);try{await navigator.clipboard.writeText(n)}catch{alert(n)}}),s("инициализация…");try{S()}catch{}t("info","Клиент загружен (Vite dev, TURN relay policy из config.js)"),j(),d()?(e&&e.classList.add("hidden"),r&&r.classList.remove("hidden"),f&&f.classList.add("hidden")):(e&&e.classList.remove("hidden"),r&&r.classList.add("hidden"),f&&f.classList.add("hidden"))})();
